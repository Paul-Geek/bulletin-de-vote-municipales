<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Bulletins de Vote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { margin: 0; padding: 0; }
            #ballot { 
                border: none !important; 
                box-shadow: none !important;
                margin: 0 !important;
            }
        }
        .print-only { display: none; }
        
        .ballot-a5 { width: 210mm; height: 148mm; }
        .ballot-a4 { width: 297mm; height: 210mm; }
        
        .draggable-image {
            cursor: move;
            position: absolute;
            z-index: 10;
            border: 2px dashed transparent;
            transition: border-color 0.2s;
            min-width: 30px;
            min-height: 30px;
            /* Limite augmentée */
            max-width: 800px; 
            max-height: 800px;
            object-fit: contain;
        }
        .draggable-image:hover { border-color: #3b82f6; }
        .draggable-image.dragging { border-color: #ef4444; opacity: 0.8; }
        
        .resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            cursor: se-resize;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 11;
        }
        .draggable-image:hover + .resize-handle,
        .resize-handle:hover { opacity: 1; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto p-6 max-w-6xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Générateur de Bulletins de Vote</h1>
        
        <div class="no-print bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom de la liste</label>
                        <input type="text" id="listName" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Entrez le nom de la liste">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Candidats au conseil municipal</label>
                        <textarea id="municipalCandidates" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Candidats au conseil communautaire</label>
                        <textarea id="communityCandidates" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Importer des visuels (PNG recommandés)</label>
                        <input type="file" id="imageUpload" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-2">
                        <div class="text-xs text-gray-600">Vous pouvez ajouter plusieurs images l'une après l'autre.</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Police et taille</label>
                        <div class="flex gap-2">
                            <select id="fontFamily" class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Helvetica">Helvetica</option>
                            </select>
                            <input type="number" id="fontSize" value="12" class="w-20 px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Couleur du bulletin</label>
                        <div class="flex space-x-2">
                            <input type="color" id="colorPicker" value="#000000" class="w-16 h-10 border rounded cursor-pointer">
                            <input type="text" id="colorHex" value="#000000" class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    
                    <button onclick="generateBallot()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md">
                        Générer / Mettre à jour le texte
                    </button>
                </div>
            </div>
        </div>
        
        <div id="ballotPreview" class="hidden">
            <div class="no-print flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Aperçu</h2>
                <div class="space-x-2">
                    <button onclick="generatePDF()" class="bg-red-600 text-white px-4 py-2 rounded-md">PDF</button>
                    <button onclick="location.reload()" class="bg-gray-600 text-white px-4 py-2 rounded-md">Réinitialiser</button>
                </div>
            </div>
            
            <div id="ballot" class="bg-white border-2 border-gray-300 mx-auto relative overflow-hidden">
                </div>
        </div>
    </div>

    <script>
        let uploadedImages = [];
        let activeImg = null;
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let resizeStartSize = { w: 0, h: 0 };
        let resizeStartPos = { x: 0, y: 0 };

        // Upload d'images multiples
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgData = e.target.result;
                    uploadedImages.push(imgData);
                    if (document.getElementById('ballotPreview').classList.contains('hidden')) {
                        generateBallot();
                    } else {
                        addNewImageToBallot(imgData);
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        function getCurrentColor() {
            return document.getElementById('colorPicker').value;
        }

        // Application de la couleur via Canvas
        function applyColorToImage(img, color) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const tempImg = new Image();
            tempImg.crossOrigin = "anonymous";
            
            if (!img.dataset.originalSrc) img.dataset.originalSrc = img.src;
            
            tempImg.onload = function() {
                canvas.width = tempImg.naturalWidth;
                canvas.height = tempImg.naturalHeight;
                ctx.drawImage(tempImg, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const target = {
                    r: parseInt(color.substr(1, 2), 16),
                    g: parseInt(color.substr(3, 2), 16),
                    b: parseInt(color.substr(5, 2), 16)
                };
                
                for (let i = 0; i < data.length; i += 4) {
                    const brightness = (data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114) / 255;
                    data[i] = target.r + (255 - target.r) * brightness;
                    data[i+1] = target.g + (255 - target.g) * brightness;
                    data[i+2] = target.b + (255 - target.b) * brightness;
                }
                ctx.putImageData(imageData, 0, 0);
                img.src = canvas.toDataURL();
            };
            tempImg.src = img.dataset.originalSrc;
        }

        function generateBallot() {
            const listName = document.getElementById('listName').value;
            const municipalText = document.getElementById('municipalCandidates').value;
            if (!listName || !municipalText) return alert("Nom et candidats requis");

            const ballot = document.getElementById('ballot');
            const municipalCandidates = municipalText.split('\n').filter(l => l.trim());
            const isA4 = municipalCandidates.length > 31;
            
            ballot.className = `border-2 border-gray-300 mx-auto relative overflow-hidden ${isA4 ? 'ballot-a4' : 'ballot-a5'}`;
            ballot.style.fontFamily = document.getElementById('fontFamily').value;
            ballot.style.fontSize = document.getElementById('fontSize').value + 'px';
            ballot.style.color = getCurrentColor();
            ballot.style.padding = '40px';

            ballot.innerHTML = `
                <div class="text-center mb-6">
                    <h1 class="font-bold text-xl">${listName}</h1>
                </div>
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <h2 class="font-bold mb-2">Conseil Municipal</h2>
                        ${municipalCandidates.map((c, i) => `<div>${i+1}. ${c}</div>`).join('')}
                    </div>
                    <div>
                        <h2 class="font-bold mb-2">Conseil Communautaire</h2>
                        ${document.getElementById('communityCandidates').value.split('\n').filter(l => l.trim()).map((c, i) => `<div>${i+1}. ${c}</div>`).join('')}
                    </div>
                </div>
            `;

            // Ré-ajouter les images stockées
            uploadedImages.forEach(imgData => addNewImageToBallot(imgData));
            document.getElementById('ballotPreview').classList.remove('hidden');
        }

        function addNewImageToBallot(imgData) {
            const ballot = document.getElementById('ballot');
            const id = 'img_' + Date.now();
            
            const img = document.createElement('img');
            img.className = 'draggable-image';
            img.id = id;
            img.src = imgData;
            img.style.top = '20px';
            img.style.left = '20px';
            img.style.width = '150px';

            const handle = document.createElement('div');
            handle.className = 'resize-handle';
            handle.id = 'handle_' + id;

            ballot.appendChild(img);
            ballot.appendChild(handle);

            img.onload = () => {
                applyColorToImage(img, getCurrentColor());
                updateHandlePos(img, handle);
            };

            img.addEventListener('mousedown', e => startDrag(e, img));
            handle.addEventListener('mousedown', e => startResize(e, img, handle));
        }

        function updateHandlePos(img, handle) {
            handle.style.left = (img.offsetLeft + img.offsetWidth - 10) + 'px';
            handle.style.top = (img.offsetTop + img.offsetHeight - 10) + 'px';
        }

        function startDrag(e, img) {
            isDragging = true;
            activeImg = img;
            const rect = img.getBoundingClientRect();
            dragOffset = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            img.classList.add('dragging');
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging) return;
            const ballot = document.getElementById('ballot').getBoundingClientRect();
            let x = e.clientX - ballot.left - dragOffset.x;
            let y = e.clientY - ballot.top - dragOffset.y;
            activeImg.style.left = x + 'px';
            activeImg.style.top = y + 'px';
            updateHandlePos(activeImg, document.getElementById('handle_' + activeImg.id));
        }

        function stopDrag() {
            isDragging = false;
            if (activeImg) activeImg.classList.remove('dragging');
            document.removeEventListener('mousemove', drag);
        }

        function startResize(e, img, handle) {
            isResizing = true;
            activeImg = img;
            resizeStartSize = { w: img.offsetWidth, h: img.offsetHeight };
            resizeStartPos = { x: e.clientX, y: e.clientY };
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            e.stopPropagation();
            e.preventDefault();
        }

        function resize(e) {
            if (!isResizing) return;
            const ratio = resizeStartSize.w / resizeStartSize.h;
            const deltaX = e.clientX - resizeStartPos.x;
            // Taille max augmentée à 800px
            let newW = Math.max(30, Math.min(800, resizeStartSize.w + deltaX));
            activeImg.style.width = newW + 'px';
            activeImg.style.height = (newW / ratio) + 'px';
            updateHandlePos(activeImg, document.getElementById('handle_' + activeImg.id));
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
        }

        async function generatePDF() {
            const ballot = document.getElementById('ballot');
            const canvas = await html2canvas(ballot, { scale: 2 });
            const { jsPDF } = window.jspdf;
            const orientation = ballot.classList.contains('ballot-a4') ? 'l' : 'l';
            const format = ballot.classList.contains('ballot-a4') ? 'a4' : 'a5';
            const pdf = new jsPDF(orientation, 'mm', format);
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
            pdf.save("bulletin.pdf");
        }

        // Sync couleur
        document.getElementById('colorPicker').addEventListener('input', function(e) {
            const color = e.target.value;
            document.getElementById('colorHex').value = color;
            document.getElementById('ballot').style.color = color;
            document.querySelectorAll('.draggable-image').forEach(img => applyColorToImage(img, color));
        });
    </script>
</body>
</html>
